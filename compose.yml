# ---------------------------------------------------------------
# Docker Compose fÃ¼r jozapf-de
# Ziel (Baseline): Nginx + PHP-FPM pro Projekt
# - MariaDB & Mailpit: aktuell NICHT aktiv, aber als Vorlage auskommentiert
# - Xdebug: per ENV toggelbar (nur im DEV-Image vorhanden), default = OFF
# - PHP-Konfiguration: versionierte Dateien unter ./docker/php/conf.d
# - Secrets: Echte Werte liegen auÃŸerhalb (SECRETS_DIR/app.env) und werden NICHT eingecheckt
# ---------------------------------------------------------------
# Wichtig:
# - PROJECT_SLUG      â†’ Compose-Projektname (fÃ¼r Container/Netzwerke)
# - PROJECT_ROOT_WINDOWS â†’ Host-Projektpfad (Windows/WSL, forward slashes) â†’ /var/www/html (Beispiel: E:/Projects/jozapf-de)
# - SECRETS_DIR       â†’ Ordner mit app.env (z. B. E:/Secrets/jozapf-de)
# ---------------------------------------------------------------

name: ${PROJECT_SLUG}

services:
  nginx:
    image: nginx:1.27-alpine
    # Nginx rendert .php NICHT selbst, sondern leitet an PHP-FPM weiter â†’ Startreihenfolge
    depends_on: [php]
    ports:
      # Ã–ffentliche HTTP-Portfreigabe (z. B. 80:80 oder 8088:80 via HTTP_PORT in .env)
      - "${HTTP_PORT:-8088}:80"
    volumes:
      # Mount des gesamten Projekt-Roots als Webroot.
      # Hintergrund: Einige Skripte lesen /var/www/html/.env bzw. assets/php/app.env direkt.
      - ${PROJECT_ROOT_WINDOWS}:/var/www/html:rw

      # Stelle sicher, dass die *Repo-*.env im Webroot liegt (nicht zu verwechseln mit Secrets!)
      # Damit kann PHP-Code .env direkt als Datei lesen, wenn er nicht nur process ENV nutzt.
      - type: bind
        source: "${PROJECT_ROOT_WINDOWS}/.env"
        target: /var/www/html/.env
        read_only: true

      # Nginx vHost-Konfiguration (bereits vorhanden)
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro

    # Optionaler Healthcheck: prÃ¼ft, ob Nginx lokal antwortet
    healthcheck:
      # PrÃ¼ft: (1) Nginx-Konfiguration gÃ¼ltig? (2) Nginx-Prozess lÃ¤uft?
      test: ["CMD-SHELL", "wget -qO- http://localhost/robots.txt >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3

  php:
    # Eigene PHP-Images (dev/prod) â€“ Xdebug ist nur im dev-Target installiert
    build:
      context: ./docker/php
      target: ${DOCKER_TARGET:-prod}               # dev | prod
      args:
        PHP_TAG: ${PHP_TAG:-8.3-fpm-alpine}

    # ðŸ” LÃ¤dt alle APP-Variablen/Secrets aus externer Datei (NICHT ins Repo!):
    env_file:
      - "${SECRETS_DIR}/app.env"                   # z. B. E:/Secrets/jozapf-de/app.env

    # âœ… Nur nicht-sensitive Toggles hier â€“ KEINE Secrets in Klartext!
    environment:
      # Xdebug: im dev-Image verfÃ¼gbar, Aktivierung per Mode
      # Werte: off | debug | develop | coverage | trace | profile (kombinierbar)
      XDEBUG_MODE: ${XDEBUG_MODE:-off}
      # Host fÃ¼r Debug-Client (unter WSL/Windows meist host.docker.internal)
      XDEBUG_CONFIG: ${XDEBUG_CONFIG:-client_host=host.docker.internal client_port=9003}

      # Optionaler Hinweis fÃ¼r Code, der die .env/ENV-Datei direkt benÃ¶tigt
      APP_ENV_FILE: /var/www/html/assets/php/app.env

    volumes:
      # Quellcode ins Container-Webroot (RW falls PHP temporÃ¤r schreibt)
      - ${PROJECT_ROOT_WINDOWS}:/var/www/html:rw
      # Versionierte PHP-INI-Konfigurationen (read-only)
      - ./docker/php/conf.d:/usr/local/etc/php/conf.d:ro

      # ðŸ” ErgÃ¤nzende Bind-Mounts: Lege die externe app.env exakt an die erwartete Stelle.
      # Das ist hilfreich, falls dein Code die Datei DIREKT einliest (statt process ENV).
      - type: bind
        source: "${SECRETS_DIR}/app.env"
        target: /var/www/html/assets/php/app.env
        read_only: true

    # Basischer Healthcheck: prÃ¼ft die PHP-Laufzeit
    healthcheck:
      test: ["CMD-SHELL", "php -v >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3

  # ---------------------------------------------------------------------------
  # Datenbank (optional) â€“ spÃ¤ter reaktivierbar
  # Aktivierung: Block einkommentieren ODER in separate Overlay-Datei auslagern
  # ---------------------------------------------------------------------------
  # db:
  #   image: mariadb:11
  #   environment:
  #     MARIADB_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-root}
  #     MARIADB_DATABASE: ${DB_NAME:-app}
  #     MARIADB_USER: ${DB_USER:-app}
  #     MARIADB_PASSWORD: ${DB_PASSWORD:-app}
  #   volumes:
  #     - dbdata:/var/lib/mysql
  #   ports:
  #     - "${DB_PORT}:3306"

  # ---------------------------------------------------------------------------
  # Dev-Mail (optional) â€“ spÃ¤ter reaktivierbar
  # ---------------------------------------------------------------------------
  # mail:
  #   image: axllent/mailpit:latest
  #   ports:
  #     - "${MAIL_HTTP_PORT}:8025"
  #   healthcheck:
  #     test: ["CMD-SHELL", "wget -qO- http://localhost:8025/healthz || exit 1"]
  #     interval: 10s
  #     timeout: 3s
  #     retries: 5
  #
volumes:
  # Bleibt inaktiv, bis 'db' wieder aktiviert wird.
  dbdata:
