# .github/workflows/deploy.yml
name: Deploy via SFTP

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      dry_run:
        description: "If true, skip SFTP uploads (build only)."
        required: true
        type: choice
        options: [ "true", "false" ]
        default: "true"

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    env:
      # ---- Remote connection (Secrets) ----
      SFTP_HOST: ${{ secrets.SFTP_HOST }}
      SFTP_PORT: ${{ secrets.SFTP_PORT }}
      SFTP_USER: ${{ secrets.SFTP_USER }}
      SFTP_PRIVATE_KEY: ${{ secrets.SFTP_PRIVATE_KEY }}

      # ---- Remote targets (Repository Variables) ----
      DOCROOT_SITE: ${{ vars.DOCROOT_SITE }}
      DOCROOT_ASSETS: ${{ vars.DOCROOT_ASSETS }}

      # ---- Local export dir ----
      SITE_DIR: out

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js (v20)
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # Find project folder by first package.json (self-healing)
      - name: Detect project directory
        id: detect
        shell: bash
        run: |
          set -euo pipefail
          CANDIDATE="$(git ls-files | awk -F/ '/(^|\/)package\.json$/ {NF--; p=$0; if (p=="") p="."; print p}' | sort -u | head -n1)"
          if [ -z "${CANDIDATE}" ]; then
            echo "::error::No package.json found in repository."
            exit 1
          fi
          echo "PROJECT_DIR=${CANDIDATE}" >> $GITHUB_ENV
          echo "Detected PROJECT_DIR=${CANDIDATE}"

      - name: Diagnose workspace
        shell: bash
        run: |
          set -e
          echo "[pwd]"; pwd
          echo "[PROJECT_DIR] $PROJECT_DIR"
          echo "[ls PROJECT_DIR]"; ls -la "$PROJECT_DIR"
          echo "[find important files]"
          find "$PROJECT_DIR" -maxdepth 3 -type f \
               \( -name package.json -o -name "generate-summary.ts" -o -name next.config.ts \) -print

      - name: Install deps
        working-directory: ${{ env.PROJECT_DIR }}
        run: npm ci

      # Safe prebuild: run only if present
      - name: Prebuild (generate summary)
        working-directory: ${{ env.PROJECT_DIR }}
        shell: bash
        run: |
          set -e
          if [ -f "scripts/generate-summary.ts" ]; then
            npx --yes tsx scripts/generate-summary.ts
          else
            echo "::notice::scripts/generate-summary.ts not found in $PROJECT_DIR – skipping prebuild."
          fi

      - name: Build
        working-directory: ${{ env.PROJECT_DIR }}
        run: npm run build

      - name: Verify out/index.html
        working-directory: ${{ env.PROJECT_DIR }}
        shell: bash
        env:
          SITE_DIR: ${{ env.SITE_DIR }}
        run: |
          test -f "$SITE_DIR/index.html" || { echo "::error::Missing $SITE_DIR/index.html"; exit 1; }

      # Prepare SSH key & known_hosts (harmless if host/port missing)
      - name: Prepare SSH
        shell: bash
        run: |
          set -e
          mkdir -p ~/.ssh
          if [ -n "${SFTP_PRIVATE_KEY:-}" ]; then
            echo "${SFTP_PRIVATE_KEY}" > ~/.ssh/deploy_key
            chmod 600 ~/.ssh/deploy_key
          fi
          if [ -n "${SFTP_HOST:-}" ]; then
            : "${SFTP_PORT:=22}"
            ssh-keyscan -p "${SFTP_PORT}" "${SFTP_HOST}" >> ~/.ssh/known_hosts 2>/dev/null || true
          fi

      # ---------------------------
      # Uploads are skipped in dry_run
      # ---------------------------

      - name: Upload site (SFTP)
        if: ${{ inputs.dry_run == 'false' }}
        working-directory: ${{ env.PROJECT_DIR }}
        shell: bash
        run: |
          set -e
          : "${SFTP_PORT:=22}"
          if [ -z "${SFTP_HOST:-}" ] || [ -z "${SFTP_USER:-}" ] || [ ! -f "${HOME}/.ssh/deploy_key" ]; then
            echo "::error::Missing SFTP credentials (SFTP_HOST/SFTP_USER/SFTP_PRIVATE_KEY)."
            exit 1
          fi
          if [ -z "${DOCROOT_SITE:-}" ]; then
            echo "::error::DOCROOT_SITE (Repo Variable) is not set."
            exit 1
          fi
          sftp -i "${HOME}/.ssh/deploy_key" -P "${SFTP_PORT}" "${SFTP_USER}@${SFTP_HOST}" <<'SFTP_CMDS'
          lcd out
          cd "$DOCROOT_SITE"
          put -r *
          SFTP_CMDS

      - name: Upload assets (SFTP, optional if exists)
        if: ${{ inputs.dry_run == 'false' }}
        working-directory: ${{ env.PROJECT_DIR }}
        shell: bash
        run: |
          set -e
          : "${SFTP_PORT:=22}"
          if [ -z "${DOCROOT_ASSETS:-}" ]; then
            echo "::notice::DOCROOT_ASSETS not set – skipping assets upload."
            exit 0
          fi
          if [ ! -d "public/assets" ]; then
            echo "::notice::No local public/assets directory – skipping assets upload."
            exit 0
          fi
          sftp -i "${HOME}/.ssh/deploy_key" -P "${SFTP_PORT}" "${SFTP_USER}@${SFTP_HOST}" <<'SFTP_CMDS'
          lcd public/assets
          cd "$DOCROOT_ASSETS"
          put -r *
          SFTP_CMDS

      # Optional: post-list / verification could be added here
