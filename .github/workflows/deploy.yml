name: Deploy via SFTP

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: "If true: only connect and list remote directories (no upload)."
        required: false
        default: "false"
        type: choice
        options: ["false", "true"]
  push:
    branches: ["main"]

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    env:
      # ---- Connection (from Secrets) ----------------------------------------
      SFTP_HOST: ${{ secrets.SFTP_HOST }}
      SFTP_PORT: ${{ secrets.SFTP_PORT }}
      SFTP_USER: ${{ secrets.SFTP_USER }}

      # ---- Remote paths (ABSOLUTE; from Variables) --------------------------
      DOCROOT_SITE: ${{ vars.HETZNER_DOCROOT_SITE }}
      DOCROOT_ASSETS: ${{ vars.HETZNER_DOCROOT_ASSETS }}

      # ---- Local paths ------------------------------------------------------
      SITE_DIR: out

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js (v20)
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install deps
        run: npm ci

      - name: Set build metadata (GIT_TAG, BUILD_DATE)
        run: |
          echo "BUILD_DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_ENV
          if [ "${GITHUB_REF_TYPE}" = "tag" ]; then
            echo "GIT_TAG=${GITHUB_REF_NAME}" >> $GITHUB_ENV
          else
            echo "GIT_TAG=${GITHUB_SHA::7}" >> $GITHUB_ENV
          fi
          echo "Using GIT_TAG=$GIT_TAG BUILD_DATE=$BUILD_DATE"

      - name: Build
        run: npm run build

      - name: Verify build output exists
        run: |
          test -f "$SITE_DIR/index.html" || { echo "::error::Missing $SITE_DIR/index.html"; exit 1; }

      - name: Prepare SSH key and known_hosts
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SFTP_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -p "$SFTP_PORT" "$SFTP_HOST" >> ~/.ssh/known_hosts

      - name: List remote (pre-check)
        run: |
          {
            printf 'cd %s\n' "$DOCROOT_SITE"
            printf 'pwd\nls -la\n'
            printf 'cd %s\n' "$DOCROOT_ASSETS"
            printf 'pwd\nls -la\n'
          } > list_pre.sftp
          sftp -b list_pre.sftp -oBatchMode=yes -i ~/.ssh/deploy_key -P "$SFTP_PORT" "$SFTP_USER@$SFTP_HOST"

      - name: Upload SITE (out -> $DOCROOT_SITE)
        if: ${{ inputs.dry_run != 'true' }}
        run: |
          {
            printf 'cd %s\n' "$DOCROOT_SITE"
            printf 'lcd %s\n' "$SITE_DIR"
            printf 'put -r *\n'
          } > upload_site.sftp
          sftp -b upload_site.sftp -oBatchMode=yes -i ~/.ssh/deploy_key -P "$SFTP_PORT" "$SFTP_USER@$SFTP_HOST"

      - name: Upload ASSETS (selected folders from out -> $DOCROOT_ASSETS)
        if: ${{ inputs.dry_run != 'true' }}
        run: |
          set -e
          FOLDERS="png jpg svg fonts ico favicon"
          : > upload_assets.sftp
          printf 'cd %s\n' "$DOCROOT_ASSETS" >> upload_assets.sftp
          printf 'lcd %s\n' "$SITE_DIR"       >> upload_assets.sftp
          queued=0
          for d in $FOLDERS; do
            if [ -d "$SITE_DIR/$d" ]; then
              printf 'put -r %s\n' "$d" >> upload_assets.sftp
              queued=1
            else
              echo "Skip: $SITE_DIR/$d not found" >&2
            fi
          done
          if [ "$queued" -eq 1 ]; then
            echo "Starting ASSETS upload to $DOCROOT_ASSETS"
            sftp -b upload_assets.sftp -oBatchMode=yes -i ~/.ssh/deploy_key -P "$SFTP_PORT" "$SFTP_USER@$SFTP_HOST"
          else
            echo "No matching asset folders found in $SITE_DIR â€“ skipping ASSETS upload."
          fi

      - name: List remote (post)
        continue-on-error: true
        run: |
          {
            printf 'cd %s\n' "$DOCROOT_SITE"
            printf 'pwd\nls -la\n'
            printf 'cd %s\n' "$DOCROOT_ASSETS"
            printf 'pwd\nls -la\n'
          } > list_post.sftp
          sftp -b list_post.sftp -oBatchMode=yes -i ~/.ssh/deploy_key -P "$SFTP_PORT" "$SFTP_USER@$SFTP_HOST"