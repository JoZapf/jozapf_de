# .github/workflows/deploy.yml
name: Deploy via SSH

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      dry_run:
        description: "If true, skip SSH uploads (build only)."
        required: true
        type: choice
        options: [ "true", "false" ]
        default: "true"

concurrency:
  group: deploy-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    env:
      # ---- Remote connection (Secrets) ----
      SSH_HOST: ${{ secrets.SSH_HOST }}
      # If SSH_PORT is not set as a secret, the scripts default to 222 (Hetzner GUI).
      SSH_PORT: ${{ secrets.SSH_PORT }}
      SSH_USER: ${{ secrets.SSH_USER }}
      SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}

      # ---- Remote targets (Repository Variables) ----
      DOCROOT_SITE: ${{ vars.HETZNER_DOCROOT_SITE }}
      DOCROOT_ASSETS: ${{ vars.HETZNER_DOCROOT_ASSETS }}

      # ---- Local export dir ----
      SITE_DIR: out

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js (v20)
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # Find project folder by first package.json (self-healing)
      - name: Detect project directory
        id: detect
        shell: bash
        run: |
          set -euo pipefail
          CANDIDATE="$(git ls-files | awk -F/ '/(^|\/)package\.json$/ {NF--; p=$0; if (p=="") p="."; print p}' | sort -u | head -n1)"
          if [ -z "${CANDIDATE}" ]; then
            echo "::error::No package.json found in repository."
            exit 1
          fi
          echo "PROJECT_DIR=${CANDIDATE}" >> $GITHUB_ENV
          echo "Detected PROJECT_DIR=${CANDIDATE}"

      - name: Diagnose workspace
        shell: bash
        run: |
          set -e
          echo "[pwd]"; pwd
          echo "[PROJECT_DIR] $PROJECT_DIR"
          echo "[ls PROJECT_DIR]"; ls -la "$PROJECT_DIR"
          echo "[find important files]"
          find "$PROJECT_DIR" -maxdepth 3 -type f \
               \( -name package.json -o -name vite.config.* -o -name next.config.* -o -name nuxt.config.* \) \
               -print || true

      - name: Install dependencies
        shell: bash
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          set -e
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Build project
        shell: bash
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          set -e
          if npm run | grep -qE '^  build'; then
            npm run build
          else
            echo "::error::No npm script \"build\" found."
            npm run
            exit 1
          fi

      - name: Verify build output
        shell: bash
        run: |
          set -e
          if [ ! -d "$SITE_DIR" ]; then
            echo "::error::SITE_DIR '$SITE_DIR' does not exist."
            exit 1
          fi
          if [ ! -f "$SITE_DIR/index.html" ]; then
            echo "::warning::No $SITE_DIR/index.html found (check your export configuration)."
          fi
          echo "[ls $SITE_DIR]"
          ls -la "$SITE_DIR"

      - name: Set DRY_RUN flag
        id: set_dry_run
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "DRY_RUN=true" >> $GITHUB_ENV
            echo "Dry-run requested via workflow_dispatch input."
          else
            echo "DRY_RUN=false" >> $GITHUB_ENV
            echo "Dry-run disabled (push or dispatch with dry_run=false)."
          fi

      - name: Prepare SSH key
        shell: bash
        run: |
          set -e
          mkdir -p "${HOME}/.ssh"
          echo "${SSH_PRIVATE_KEY}" > "${HOME}/.ssh/deploy_key"
          chmod 600 "${HOME}/.ssh/deploy_key"

      - name: Add host key to known_hosts
        shell: bash
        run: |
          set -e
          : "${SSH_PORT:=222}"
          ssh-keyscan -p "${SSH_PORT}" "${SSH_HOST}" >> "${HOME}/.ssh/known_hosts"

      - name: Dry-run notice (no upload)
        if: env.DRY_RUN == 'true'
        shell: bash
        run: |
          echo "::notice::Dry-run enabled – build completed, no files uploaded."

      - name: Upload site via SSH
        if: env.DRY_RUN != 'true'
        shell: bash
        run: |
          set -e
          : "${SSH_PORT:=222}"

          if [ -z "${SSH_HOST:-}" ] || [ -z "${SSH_USER:-}" ] || [ -z "${SSH_PRIVATE_KEY:-}" ]; then
            echo "::error::Missing SSH credentials (SSH_HOST/SSH_USER/SSH_PRIVATE_KEY)."
            exit 1
          fi
          if [ -z "${DOCROOT_SITE:-}" ]; then
            echo "::error::DOCROOT_SITE (Repo Variable) is not set."
            exit 1
          fi
          if [ ! -d "${SITE_DIR}" ]; then
            echo "::error::SITE_DIR '${SITE_DIR}' does not exist."
            exit 1
          fi

          echo "::notice::Uploading site to ${SSH_USER}@${SSH_HOST}:${DOCROOT_SITE} (port ${SSH_PORT})"
          sftp -i "${HOME}/.ssh/deploy_key" -P "${SSH_PORT}" "${SSH_USER}@${SSH_HOST}" <<SSH_CMDS
          lcd ${SITE_DIR}
          cd ${DOCROOT_SITE}
          put -r *
          SSH_CMDS

      - name: Upload assets via SSH
        if: env.DRY_RUN != 'true'
        shell: bash
        run: |
          set -e
          : "${SSH_PORT:=222}"

          if [ -z "${DOCROOT_ASSETS:-}" ]; then
            echo "::notice::DOCROOT_ASSETS not set – skipping assets upload."
            exit 0
          fi
          # Try assets-deploy first (new location), fallback to public/assets
          ASSETS_SOURCE=""
          if [ -d "assets-deploy" ]; then
            ASSETS_SOURCE="assets-deploy"
            echo "::notice::Using assets-deploy directory"
          elif [ -d "public/assets" ]; then
            ASSETS_SOURCE="public/assets"
            echo "::notice::Using public/assets directory (legacy)"
          else
            echo "::notice::No assets directory found – skipping assets upload."
            exit 0
          fi

          echo "::notice::Uploading assets from ${ASSETS_SOURCE} to ${SSH_USER}@${SSH_HOST}:${DOCROOT_ASSETS} (port ${SSH_PORT})"
          sftp -i "${HOME}/.ssh/deploy_key" -P "${SSH_PORT}" "${SSH_USER}@${SSH_HOST}" <<SSH_CMDS
          lcd ${ASSETS_SOURCE}
          cd ${DOCROOT_ASSETS}
          put -r *
          SSH_CMDS
