jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js (v20)
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Detect project directory
        id: detect
        shell: bash
        run: |
          set -euo pipefail
          CANDIDATE="$(git ls-files | awk -F/ '/(^|\/)package\.json$/ {NF--; p=$0; if (p=="") p="."; print p}' | sort -u | head -n1)"
          if [ -z "${CANDIDATE}" ]; then
            echo "::error::No package.json found in repository."
            exit 1
          fi
          echo "PROJECT_DIR=${CANDIDATE}" >> $GITHUB_ENV
          echo "Detected PROJECT_DIR=${CANDIDATE}"

      - name: Diagnose workspace
        shell: bash
        run: |
          set -e
          echo "[pwd]"; pwd
          echo "[PROJECT_DIR] $PROJECT_DIR"
          echo "[ls PROJECT_DIR]"; ls -la "$PROJECT_DIR"
          echo "[find important files]"
          find "$PROJECT_DIR" -maxdepth 3 -type f \( -name package.json -o -name "generate-summary.ts" -o -name next.config.ts \) -print

      - name: Install deps
        working-directory: ${{ env.PROJECT_DIR }}
        run: npm ci

      - name: Prebuild (generate summary)
        working-directory: ${{ env.PROJECT_DIR }}
        shell: bash
        run: |
          set -e
          if [ -f "scripts/generate-summary.ts" ]; then
            npx --yes tsx scripts/generate-summary.ts
          else
            echo "::notice::scripts/generate-summary.ts not found in $PROJECT_DIR – skipping prebuild."
          fi

      - name: Build
        working-directory: ${{ env.PROJECT_DIR }}
        run: npm run build

      - name: Verify out/index.html
        working-directory: ${{ env.PROJECT_DIR }}
        shell: bash
        env:
          SITE_DIR: out
        run: |
          test -f "$SITE_DIR/index.html" || { echo "::error::Missing $SITE_DIR/index.html"; exit 1; }

      # SSH + SFTP-Schritte bleiben wie zuvor – Uploads werden bei dry_run=true übersprungen.
      - name: SSH known_hosts
        shell: bash
        env:
          SFTP_HOST: ${{ secrets.SFTP_HOST }}
          SFTP_PORT: ${{ secrets.SFTP_PORT }}
        run: |
          set -e
          if [ -z "${SFTP_HOST:-}" ]; then
            echo "::notice::SFTP_HOST not set – skipping ssh-keyscan."
            exit 0
          fi
          : "${SFTP_PORT:=22}"
          mkdir -p ~/.ssh
          ssh-keyscan -p "${SFTP_PORT}" "${SFTP_HOST}" >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: List remote (pre)
        if: ${{ inputs.dry_run == 'false' }}
        working-directory: ${{ env.PROJECT_DIR }}
        run: echo "TODO: your pre-list SFTP batch here"

      - name: Upload site
        if: ${{ inputs.dry_run == 'false' }}
        working-directory: ${{ env.PROJECT_DIR }}
        run: echo "TODO: your site upload SFTP batch here"

      - name: Upload assets
        if: ${{ inputs.dry_run == 'false' }}
        working-directory: ${{ env.PROJECT_DIR }}
        run: echo "TODO: your assets upload SFTP batch here"

      - name: List remote (post)
        if: ${{ inputs.dry_run == 'false' }}
        working-directory: ${{ env.PROJECT_DIR }}
        run: echo "TODO: your post-list SFTP batch here"
