# ---------------------------------------------------------------
# Nginx VHost – Statischer Next-Export + PHP-FPM
# Root: /var/www/html
# Ziele:
#  - Statische Auslieferung bevorzugen (Next export, trailingSlash)
#  - Saubere PHP-FPM-Anbindung nur für echte .php-Dateien
#  - Security (Dotfiles/Config sperren), sinnvolle Caching-Header
# ---------------------------------------------------------------
server {
  listen 80;
  server_name localhost;

  charset utf-8;
  root /var/www/html;

  # Für statische Seiten zuerst HTML versuchen
  index index.html index.php;

  # ---------------------------
  # Security Headers (Basis)
  # ---------------------------
  add_header X-Content-Type-Options "nosniff" always;
  add_header X-Frame-Options "SAMEORIGIN" always;
  add_header Referrer-Policy "strict-origin-when-cross-origin" always;
  add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

  # ---------------------------
  # Sperren sensibler Dateien
  # ---------------------------
  # Dotfiles (ausgenommen .well-known)
  location ~ /\.(?!well-known).* { deny all; }

  # Typische Konfig-/Dump-Dateien
  location ~* \.(?:env|ini|log|sql|sqlite|bak|conf)$ { deny all; }

  # ---------------------------
  # Statische Auslieferung
  # ---------------------------
  # Next-immutable Assets: 1 Jahr, immutable
  location ^~ /_next/static/ {
    expires 1y;
    add_header Cache-Control "public, immutable, max-age=31536000" always;
    try_files $uri =404;
  }

  # Generische Assets (falls genutzt): 30 Tage
  location ~* \.(?:css|js|mjs|jpg|jpeg|gif|png|svg|ico|webp|avif|woff2?|ttf|eot)$ {
    expires 30d;
    add_header Cache-Control "public, max-age=2592000" always;
    try_files $uri =404;
  }

  # HTML nie cachen (Export-Seiten)
  location ~* \.html$ {
    add_header Cache-Control "no-store" always;
    try_files $uri =404;
  }

  # Sitemap/Robots: moderates Caching
  location = /robots.txt  { add_header Cache-Control "public, max-age=86400" always; try_files $uri =404; }
  location = /sitemap.xml { add_header Cache-Control "public, max-age=86400" always; try_files $uri =404; }

  # Favicon/Manifest – kein Logging bei NotFound
  location = /favicon.ico  { log_not_found off; access_log off; try_files $uri =404; }
  location = /site.webmanifest { try_files $uri =404; }

  # Default-Location: statisch bevorzugen, sonst auf index.html fallen (SPA/Export)
  location / {
    try_files $uri $uri/ /index.html;
  }

  # ---------------------------
  # PHP-FPM (nur echte Dateien)
  # ---------------------------
  location ~ \.php$ {
    # Nur vorhandene Dateien an FPM geben
    try_files $uri =404;

    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    fastcgi_pass php:9000;

    # Puffer/Timeouts konservativ
    fastcgi_buffering on;
    fastcgi_buffers 8 16k;
    fastcgi_read_timeout 60s;
  }

  # Upload-Limit
  client_max_body_size 20m;

  # Mime-Erweiterung für WASM (falls benötigt)
  include /etc/nginx/mime.types;
}
